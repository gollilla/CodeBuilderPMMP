<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="./main.css?id=0000" />
    <title>PMMP CodeBuilder</title>
</head>

<body>
    <button onclick="codeTo()">コード表示</button>
    <div class="link-to-github"><img id="github-logo" src="./GitHub-Mark-32px.png"> To GitHub</div>
    <div class="container">
        <div id="editor"></div>
        <div id="code"></div>
    </div>

    <div class="toolbox-area"></div>

    <xml id="examples" xmlns="https://developers.google.com/blockly/xml" style="display: none;">
        <variables>
            <variable id="Qoy:zatDMHB@w~RDRoU{">event</variable>
            <variable id="/ZSCYbn_M{E|@1=6Mg]v">player</variable>
        </variables>
        <block type="eventhandler" id="E0|ie+O+xm4Ide{k]4vz" x="40" y="35">
            <field name="eventList">PlayerJoinEvent</field>
            <field name="event" id="Qoy:zatDMHB@w~RDRoU{">event</field>
            <statement name="doing">
                <block type="variables_set" id="LVcJyZKX%K7Pf(]N95Xw">
                    <field name="VAR" id="/ZSCYbn_M{E|@1=6Mg]v">player</field>
                    <value name="VALUE">
                        <block type="getter" id="L-`buAh1}Er]g#+ad?)s">
                            <value name="objects">
                                <block type="variables_get" id="D{r0G5?iYZ%fGo9YOxKI">
                                    <field name="VAR" id="Qoy:zatDMHB@w~RDRoU{">event</field>
                                </block>
                            </value>
                            <value name="value">
                                <block type="text" id="ut?@i(kJiDGv*]CB*mzv">
                                    <field name="TEXT">Player</field>
                                </block>
                            </value>
                        </block>
                    </value>
                    <next>
                        <block type="sendmessage" id="26I/7YBnJ|$+9^35-{eK">
                            <value name="value">
                                <block type="variables_get" id="0G;lc(5?HFF1^8j|B:t7">
                                    <field name="VAR" id="/ZSCYbn_M{E|@1=6Mg]v">player</field>
                                </block>
                            </value>
                            <value name="message">
                                <block type="text" id="0[}P@H$JN!i5^O2?~md3">
                                    <field name="TEXT">こんにちは</field>
                                </block>
                            </value>
                        </block>
                    </next>
                </block>
            </statement>
        </block>
    </xml>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/ext-language_tools.min.js"></script>
    <script src="./blockly_compressed.js"></script>
    <script src="./blocks_compressed.js"></script>
    <script src="./javascript_compressed.js"></script>
    <script src="./php_compressed.js"></script>
    <script src="./pmmp_blocks.js"></script>
    <script src="./pmmp_code_gen.js"></script>
    <script src="./msg/js/ja.js"></script>
    <script>
        let workspace;
        let editor;
        $(function () {
            $(".toolbox-area").load("./toolbox.xml", (data, status, obj) => {
                workspace = Blockly.inject('editor', {
                    toolbox: document.getElementById("toolbox"), maxBlocks: Infinity, sounds: false, trashcan: true, zoom: {
                        controls: true,
                        wheel: false,
                        startScale: 1,
                        maxScale: 3,
                        minScale: 0.3,
                        scaleSpeed: 1.2
                    }
                });
                Blockly.Xml.domToWorkspace(document.getElementById('examples'), workspace);
            });

            editor = ace.edit("code");
            editor.$blockScrolling = Infinity;
            editor.setOptions({
                enableBasicAutocompletion: true,
                enableSnippets: true,
                enableLiveAutocompletion: true,
                enableAutoIndent: true
            });
            editor.setTheme("ace/theme/monokai");
            editor.getSession().setMode("ace/mode/php");
            editor.setFontSize(20);
            editor.setShowPrintMargin(false);
        });

        $(".link-to-github").click(() => {
            window.open("https://github.com/gollilla/CodeBuilderPMMP", "_blank");
        });

        function codeTo() {
            let code = Blockly.PHP.workspaceToCode(workspace);
            code = "<?php\n"
                + "namespace test\\test;\n\n"
                + "use pocketmine\\event\\player\\{\n"
                + "                PlayerJoinEvent,\n"
                + "                PlayerMoveEvent,\n"
                + "                PlayerQuitEvent\n"
                + "};\n\n"
                + "class Main extends PluginBase implements Listener {\n\n"
                + "    public function onEnable(){\n"
                + "        $this->getServer()->getPluginManager()->registerEvents($this, $this);\n"
                + "    }\n"
                + "\n"
                + code;
            code = code
                + "}\n";
            editor.setValue(code);
            editor.getSelection().clearSelection();
            setTimeout(() => {
                editor.autoIndent();
            }, 10);

        }



    </script>
</body>

</html>